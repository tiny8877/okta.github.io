---
layout: docs_page
title: Mulesoft Integration Guide
excerpt: Integrate Okta's API Access Management with Mulesoft.
---
# Mulesoft Integration Guide

This guide describes the process of integrating Okta’s API Access Management with Mulesoft. Okta serves as an authorization server and mints access tokens for users. Mulesoft manages API resources and checks for a valid token before allowing access to a resource.

You will be able to set up multiple Okta clients through Mulesoft (dynamic client registration).

## Example Integration

A [complete integration example](https://okta-api-am.herokuapp.com/mulesoft) on Heroku illustrates authentication and shows decoded access tokens for two different users.

## Prerequisites

To build your own integration you need:

* An API. You can use the Okta test API if you don't have one: [https://okta-solar-system.herokuapp.com/](https://okta-solar-system.herokuapp.com/).
* An Okta org with API Access Management enabled. You can [sign up for an Okta developer account](https://developer.okta.com/signup/) 
* [Mulesoft's Anypoint platform](https://www.mulesoft.com/platform/enterprise-integration)
* Web server and an application. Your application needs at least a simple page to accept access tokens coming back from Okta: `localhost` is sufficient.

Throughout this guide, we assume that you are using the Okta test API (solar system). The scenario is that the solar system API requires silver-level access to reach the `/planets` endpoint, and gold-level access to reach the `/moons` endpoint. These requirements affect the entire setup, but you can of course use your own API and policies instead.

## Set Up Steps

1. [Set up an Okta org](#step-one-set-up-an-okta-org).
    * Set up an authorization server (and groups)
    * Get an API key
    * Set up an OIDC client

2. [Set up a Mulesoft API](#step-two-set-up-mulesoft).
    * Add Okta as an External OAuth 2.0 server
    * Design/Add a new API
    * Set up a portal for your API
    * Configure an API endpoint
    * Set policies for the API
    * Deploy the API
    * Set up a new application with access to the API

3. [Test the integration]().
    * Assign the new application to users/groups in Okta
    * Create an authentication URL
    * Get an access token


### Step One: Set Up an Okta Org

1. Create and configure an authorization server (and groups) using [these instructions](/docs/integration-guides/setting-up-okta-for-integration-examples).

2. Create an Okta token (API key) as a user with the correct permissions, typically a Super Administrator.
    * For Okta Enterprise edition, choose **Security > API > Tokens > Create Token**
    * For Okta Developer edition's Developer Console, choose **API > Tokens > Create Token**
    Copy your token and keep it handy, because you will need to provide it to Mulesoft later.

3. Set up an OpenId Connect client.
    * For Okta Enterprise edition, press the Admin button and select **Applications > Applications > Add Application > Create New App**, and choose **Platform: Web** and **Sign on method: OpenID Connect**.
        The app you create, an OpenId Connect client, will be used to introspect all tokens for clients generated by Mulesoft.

        {% img mulesoft-create-oidc-app.png alt:"Create OpenID Connect Integration page with recommended values" %}

        In the **Create OpenID Connect Integration** page, specify these settings:
        * **Application name**: `mulesoft introspection client`
        * **Login redirect URI**: `http://localhost`
    
        The Login redirect URI value isn't used in this example. You can set it to anything.

        Click **Save** to display your Client ID and Client secret.

        {% img mulesoft-integration-clientid-and-secret.png alt:"Client Credentials page" %}

        Click **Edit** and select **Client Credentials** as an allowed grant type.

        Click Save and skip to step 4.

    * For Okta Developer edition, from the Developer Console select **Applications > Add Application > Service > Next**.
        {% img mulesoft-int-dev-console-create.png alt:"Create App pane in Developer Console" %}

        Enter the name `mulesoft introspection client` and click **Done**.
        {% img mulesoft-int-client-cred-screen.png alt:"Client Credentials screen" %}

        Copy the Client ID and Client secret and keep them handy. You will use them in your Mulesoft setup.

### Step Two: Set Up Mulesoft

1. Add Okta as an External OAuth 2.0 server
    Note: Mulesoft allows only one external OAuth 2.0 Server (authorization server) to be defined per Mulesoft tenant.

    In your Mulesoft Anypoint tenant, go to **Management Center > Access Management > External Identity > Client Management > OpenID Connect Dynamic Client Registration**
    {% img mulesoft-int-anypoint-setup1.png alt:"External Identity creation screen" %}

    Enter these values:
    * For **Client Registration URL**, enter `${yourOktaDomain}.com/oauth2/v1/clients`
    * Select **Advanced Settings** and enter the following values:
        * **Authorization Header**: SSWS ${okta_api_key}
        * **Token Introspection Client**: Enter the Client ID and client secret from the app you created in the previous step.
        * **OpenID Connect Authorization URLs**: Enter these values:
            * **Authorize URL**: ${yourOktaDomain}.com/oauth2/${auth_server_id}/v1/authorize
            * **Token URL**: ${yourOktaDomain}.com/oauth2/${auth_server_id}/v1/token
            * **Token Introspection URL**: ${yourOktaDomain}/oauth2/${auth_server_id}/v1/introspect
    
    Choose **Save** to complete this step. Your Okta org is now an external identity provider.

2. Design or Add a New API

    > Important: Adding a new API works differently depending on the Mulesoft tenant that you have, an older one (pre July 2017) or a newer one. To check and see which version you have, go to Design Center and click “Create”. If you see an option for “API Specification” then you have a new tenant. If you do not see an option for “API Specification” then you have an older tenant. Instructions for older tenants are covered in a separate doc.

    * Navigate to **Design Center > Create > API Specification** and enter a project name, and select **Start with API designer**, then select **Create**.

        You now have an (almost) empty RAML file to design your API.

Copy and paste the RAML template file (at the end of this doc) into this editor. Make sure you update:

the baseUri (if you are not using the Okta sample app)
the authorizationUri
the accessTokenUri

Update the “Resources” section if you are using your own API and want to define your own resources.

The file should save automatically; you can do command-s to force the save.

Now click the “Publish to Exchange” icon.






Click Publish.

Now go to API Manager.

Click the “Manage API dropdown”, and “Manage API from Exchange”



Start typing your API name (“solar-system”) in the API name field to search for it.



Click Save.



Enter a unique name for your proxy application on cloudhub and click Deploy.

Your proxy is now deployed.
Set policies
On your main settings screen, click “Policies” on the left-hand menu.


Click “Apply new Policy”

Choose “OpenID Connect access token enforcement”



Click “Configure Policy”

In the Scopes box, add

http://myapp.com/scp/silver

and add it to the GET method of /planets



Click “Apply” to finish setting up the mulesoft access policy.



If you wish, repeat the same steps for the /moons endpoint, but with a scope of http://myapp.com/scp/gold

Now test the endpoint /planets on your proxy, and you should get an error message that you are missing an access token.

http://tom-test-okta.cloudhub.io/planets



At this point, you can test the integration by getting an access token using the introspection client that you set up earlier (skip to the section “test the integration”).

Or, you can test the integration by building a new client using dynamic client registration.
Set up a new application with access to the API
To set up a new application with access to the API, go to the main settings screen for your API and click “View API in Exchange”.





Click on the three dots next to the Edit icon, and then “Request Access”






Click “create a new application” 



Grant types
It’s up to you to decide which OAuth grant types you want to allow. In this example we’ll be using the Implicit Grant type, so select that as a minimum.

redirect_uris
The application needs at least one redirect uri to send tokens to. For now, put in at least one URL that you control, such as a test page on localhost. You can add additional redirect_uris later in your Okta tenant.

Click the “create” button.



Click “request API access” and you will get a client id and client secret.



This step has created a new OIDC app in your Okta tenant.
Test the integration
You can now test the endpoint and access token. Test the integration with a basic front-end.

Note: this process is for testing purposes only. In a production environment, you should properly include values for “nonce” and “state”, and you should pass the access token in the header rather than as a url parameter.

Assign the new application to users/groups in Okta
Go to your Okta tenant.
For the OIDC app that Mulesoft just created in Okta, you need to assign this application to any Okta users who will need to authenticate against it. For PoC purposes, it’s easiest to just assign the application to the “everyone” group. Or you can assign it just to the groups that you’ve created for this app (silverSubscribers, e.g.).
Make sure you have at least one activated member of the “silverSubscribers” group in Okta. For the purposes of this example, we are using carl.sagan@mailinator.com as our representative member of the silverSubscribers group.
Create an authentication URL
Put the following link on the web page that is your redirect_uri, substituting the appropriate values from your Okta tenant
https://partnerpoc.oktapreview.com/oauth2/ausce8ii5wBzd0zvQ0h7/v1/authorize?response_type=token&client_id=0oackbggxnLe1jjl00h7&redirect_uri=http://localhost:8888/mulesoft&scope=api:read:silver&state=someState&nonce=someNonce
Get an access token
Click on the link to get an access token

Clicking on the link will take you to your Okta tenant to authenticate. When you authenticate successfully, you will be redirected back to your web page (redirect_uri) with an access token in the url:



Extract the access token from the URL, and then include it as a parameter in a request to your cloudhub endpoint:

http://okta-solar-system.cloudhub.io/?access_token={{access_token}}

You should now get a list of the planets.



RAML file

#%RAML 1.0
title: solar-system
version: 01
baseUri: https://okta-solar-system.herokuapp.com
#### EDIT THE baseUri as appropriate

securitySchemes:
  oauth_2_0:
    description: |
      This API supports OAuth 2.0 for authenticating all API requests.
    type: OAuth 2.0
    describedBy:
      headers:
        Authorization:
          description: |
             Used to send a valid OAuth 2 access token. Do not use with the "access_token" query
             string parameter.
          type: string
      queryParameters:
        access_token:
          description: |
             Used to send a valid OAuth 2 access token. Do not use together with the "Authorization"
             header
          type: string
      responses:
        401:
          description: |
            Bad or expired token. This can happen if the user or the API revoked or expired an
            access token. To fix, you should re-authenticate the user.
        403:
          description: |
            Bad OAuth request (wrong consumer key, bad nonce, expired timestamp...). Unfortunately,
            re-authenticating the user won't help here.
    settings:
      authorizationUri: https://partnerpoc.oktapreview.com/oauth2/ausce8ii5wBzd0zvQ0h7/v1/authorize
      accessTokenUri: https://partnerpoc.oktapreview.com/oauth2/ausce8ii5wBzd0zvQ0h7/v1/token
      authorizationGrants: ["authorization_code","implicit"]
      #### *** EDIT the authorizationUri and the accessTokenUri **** ####

## Resources
##### *** LEAVE THIS SECTION ALONE UNLESS YOU WANT TO CHANGE FOR YOUR OWN API *** #####

/planets:
 get:
   securedBy: [oauth_2_0]

/moons:
 get:
   securedBy: [oauth_2_0]
